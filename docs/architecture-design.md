# Docker Swarm 分布式共享存储解决方案

## 📋 项目概述

本项目提供一个生产级的Docker Swarm分布式共享存储解决方案，实现跨节点NFS共享存储、多应用隔离、自动备份恢复等企业级功能。

### 🎯 核心价值
- **高可用性**: Docker Swarm集群保证服务高可用
- **数据隔离**: 多应用间存储完全隔离，安全可靠
- **自动备份**: 支持多版本增量备份，数据安全有保障
- **易于扩展**: 新应用可快速接入共享存储
- **运维友好**: 完整的监控、日志、故障恢复机制

### 🛠️ 技术栈选型

| 组件 | 技术选择 | 版本要求 | 作用 |
|------|----------|----------|------|
| 容器编排 | Docker Swarm | 20.10+ | 服务调度、负载均衡、故障恢复 |
| 共享存储 | NFS v4 | - | 跨节点文件共享 |
| 备份同步 | rclone | latest | WebDAV协议备份到云端 |
| 网络通信 | Overlay Network | - | 服务间安全通信 |
| 权限控制 | 主机名ACL | - | 基于服务名的访问控制 |
| Web服务 | Nginx | alpine | 应用服务示例 |

## 🏗️ 系统架构设计

### 核心架构原则
1. **分层解耦**: 存储层、应用层、网络层独立设计
2. **服务隔离**: 不同应用数据完全隔离，互不影响
3. **高可用性**: 关键服务多副本部署，自动故障恢复
4. **可扩展性**: 新应用可快速接入，存储可动态扩容

### 技术方案详解

#### 1. NFS多应用隔离方案
**问题**: 如何在单一NFS服务器上为多个应用提供隔离的存储空间？

**解决方案**:
- **物理隔离**: `/home/Net_Volumes/{app1,app2,app3,shared}` 目录结构
- **逻辑隔离**: NFS导出配置 `/exports/{app1,app2,app3,shared}`
- **访问控制**: 基于主机名白名单的ACL机制
- **权限管理**: 每个应用只能挂载自己的专用目录+共享目录
- **部署方式**: NFS服务直接部署在物理机上，通过shell脚本管理

#### 2. 多版本备份恢复方案
**问题**: 如何实现可靠的数据备份和灵活的版本恢复？

**解决方案**:
- **增量备份**: 基于文件时间戳的增量备份策略
- **版本管理**: WebDAV存储多个备份版本，支持时间点恢复
- **完整性校验**: MD5校验确保备份数据完整性
- **选择性恢复**: 支持全量恢复或指定应用数据恢复

#### 3. 网络隔离与安全方案
**问题**: 如何确保存储网络安全，防止未授权访问？

**解决方案**:
- **物理机部署**: NFS服务直接部署在物理机上，避免容器网络复杂性
- **接口绑定**: NFS服务绑定到指定网络接口(默认wt0)
- **防火墙集成**: 自动管理防火墙规则，只允许授权主机访问
- **主机名白名单**: 基于主机名的访问控制列表
- **端口安全**: NFS端口只在指定接口上监听

## 📦 服务组件设计

### 存储基础设施层

| 组件名 | 部署方式 | 功能描述 |
|--------|----------|----------|
| nfs_server | Docker Compose服务 | NFSv4服务器，提供多应用隔离存储 |
| backup_manager | Docker Swarm服务 | 自动备份服务，每6小时增量备份 |

#### NFS服务器 (nfs_server)
```yaml
核心功能:
- NFSv4协议支持，Docker容器化部署
- 多应用目录隔离 (/nfs_volumes/{app1,app2,app3,shared})
- 端口绑定到wt0接口，避免防火墙配置
- 基于主机名白名单的访问控制
- 独立于Swarm的Docker Compose部署

技术实现:
- Alpine Linux + nfs-utils容器
- 端口直接绑定到wt0接口IP
- 环境变量驱动的配置生成
- 主机名白名单验证
- 容器化生命周期管理
```

#### 备份管理服务 (backup_manager)
```yaml
核心功能:
- 定时增量备份: 每6小时自动备份
- WebDAV协议上传到云端
- 多版本管理，保留180天备份
- 备份完整性校验
- 按需恢复支持

技术实现:
- Kopia增量备份引擎
- 动态WebDAV URL解析
- 自动重连机制
- 智能仓库检测和创建
- 彩色日志输出
```

### 2.3 网络架构

#### 2.3.1 物理网络设计

**NFS服务器网络**
- Docker Compose容器化部署
- 端口直接绑定到wt0接口IP
- 无需额外防火墙配置

**Docker Swarm网络**
- 应用服务使用overlay网络
- 通过localhost访问NFS服务
- 服务间通信和负载均衡

#### 2.3.2 访问控制策略

**基于主机名的白名单机制**
- 环境变量配置允许访问的主机名列表
- NFS导出配置限制客户端访问
- 防火墙规则自动管理

## 3. 存储设计

### 3.1 存储结构

```
nfs_srv 本地卷名（例如）：nfs_srv_vol
nfs_srv_vol/
├── shared_data/          # 共享应用数据
├── app_NAME1/            # 应用1专用数据
├── app_NAME2/            # 应用2专用数据
├── app_configs/          # 应用配置文件
├── logs/                 # nfs服务日志文件


nfs_srv在远端webdav服务上的存储
davs://server/home/net-volumes/
├── nfs_srv_vol/          # $VOLUMES_NAME 的备份
    ├── shared_data/          # 共享应用数据
    ├── app_NAME1/            # 应用1专用数据
    ├── app_NAME2/            # 应用2专用数据
    ├── nfs_configs/          # nfs服务配置文件
    ├── logs/                 # 日志文件
    └── backup_historys/      # 备份的历史版本管理（对nfs卷中除备份和日志的每个文件夹，即apps的卷单独进行备份的版本管理）
        ├── shared_data/
        │   ├── 2024-07-10_00-00/    # 完整备份
        │   ├── 2024-07-10_06-00/    # 增量备份
        │   ├── 2024-07-10_12-00/    # 增量备份
        │   └── metadata.json        # 版本元数据
        ├── app_NAME1/
        │   ├── 2024-07-10_00-00/
        │   ├── 2024-07-10_06-00/
        │   ├── 2024-07-10_12-00/

```

### 3.2 权限模型

- **存储隔离**: 不同应用使用不同的子目录
- **访问控制**: 基于Docker服务名称的网络访问控制
- **数据安全**: NFS导出配置限制访问范围

## 4. 备份恢复策略

### 4.1 备份策略

**自动备份**
- 频率: 每6小时执行一次
- 类型: 增量备份
- 目标: WebDAV服务器
- 记录: 备份记录时间（使用互联网真实时间ntp服务，避免因为docker节点时间错误而导致备份版本管理时间错落）和元数据

**备份流程**
1. rclone同步本地数据到WebDAV
2. 生成备份元数据
3. 清理过期备份(由环境变量控制，默认180天)
4. 记录备份日志

### 4.2 恢复策略

**按需恢复**
- 手动触发恢复服务
- 支持指定时间点恢复
- 支持选择性恢复
- 数据一致性检查

## 5. 部署架构

### 5.1 部署顺序

1. 部署NFS服务器 (Docker Compose)
2. 验证NFS服务可用性
3. 部署备份管理服务 (Docker Swarm)
4. 部署应用服务 (Docker Swarm)
5. 测试完整流程

### 5.2 配置管理

**Docker Secrets**
- WebDAV认证信息
- NFS访问密钥
- 应用配置敏感信息

**Environment Variables**
- 服务配置参数
- 网络配置
- 存储路径配置

## 6. 监控和维护

### 6.1 健康检查

- NFS服务可用性检查，自动维持，避免依赖他的apps无法启动，或者崩溃（请根据docker机制合理来合理设计）
- 备份服务webdav连接状态检查，自动维持（每几分钟分钟重试即可）
- 备份任务执行状态
- 存储空间监控
- 网络连通性检查

### 6.2 故障恢复

- 自动重启机制
- 数据恢复流程
- 服务降级策略
- 告警通知机制

## 7. 安全考虑

### 7.1 网络安全

- Overlay网络隔离
- 服务间通信加密
- 访问控制列表

### 7.2 数据安全

- 传输加密
- 存储加密
- 备份数据完整性校验

## 8. 性能优化

### 8.1 存储性能

- NFS缓存优化
- 网络带宽管理
- 并发访问控制

### 8.2 备份性能

- 增量备份策略
- 压缩传输
- 并行同步

---

